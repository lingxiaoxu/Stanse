rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 用户数据 - 只有认证用户可以读写自己的数据
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow count aggregation for registration check (no document data exposed)
      allow get: if false;
      allow list: if request.auth != null && request.query.limit == null;
    }

    // 已删除用户数据 - 用户删除账户时转移数据到此集合
    // Users can only write to their own userId document (for account deletion)
    // No read access - data is archived for backup purposes only
    match /users_deleted/{userId} {
      allow read: if false; // Archived data - no read access
      allow write: if request.auth != null && request.auth.uid == userId;

      // Subcollections (chatHistory, ember_cost_sessions, etc.)
      match /{subcollection}/{docId} {
        allow read: if false;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Polis Protocol user data
    match /polis_users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // User actions - users can read/write their own actions
    match /user_actions/{actionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // FEC 公开数据 - 所有人可读，禁止写入

    // Multi-year collections (包含所有年份的数据)
    match /fec_raw_committees/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_candidates/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_linkages/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_transfers/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Year-specific contribution collections (每个年份一个独立集合)
    // Collection names use short year format: _24, _22, _20, _18, _16
    match /fec_raw_contributions_pac_to_candidate_24/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_22/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_20/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_18/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_16/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Company indexes and summaries
    match /fec_company_index/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_company_party_summary/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_company_name_variants/{docId} {
      allow read: if true;
      allow write: if request.auth != null;  // Authenticated users can update variants with AI
    }

    match /fec_company_consolidated/{docId} {
      allow read: if true;
      allow write: if false;  // Read-only for clients
    }

    // Polis Protocol 数据 - 需要认证
    match /polis_transactions/{txId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // 新闻和更新 - 公开读，管理员写，但也允许认证用户缓存
    match /news/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 新闻原文 - 存储未 summarize 的原始新闻内容（用于 breaking news 检测）
    match /news_original/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Breaking News 通知 - 认证用户可以读取和更新（标记为已读）
    match /breaking_news_notifications/{notificationId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null; // Allow marking as read
      allow create, delete: if false; // Only Cloud Functions
    }

    // 通知日志 - 认证用户可以读取
    match /notification_logs/{logId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions
    }

    // 新闻图片缓存 - 认证用户可以读写
    match /news_images/{document=**} {
      allow read, write: if request.auth != null;
    }

    // 新闻向量嵌入缓存 - 认证用户可以读写
    match /news_embeddings/{document=**} {
      allow read, write: if request.auth != null;
    }

    // 公司排名缓存 - DEPRECATED, use enhanced_company_rankings instead
    // Allow public read/write for backward compatibility during migration
    match /company_rankings/{document=**} {
      allow read: if true;
      allow write: if true;  // Allow public write for development/migration
    }

    // Enhanced company rankings with persona-aware scoring (including history subcollection)
    // Public read and write (for development/testing - frontend can generate rankings)
    match /enhanced_company_rankings/{persona} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company rankings by ticker (FEC + ESG + Executive + News data)
    // Public read and write (for development/testing - backend scripts can write)
    match /company_rankings_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company ESG data by ticker with history tracking
    // Public read and write (for development/testing)
    match /company_esg_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company executive statements by ticker with history tracking
    // Public read and write (for development/testing)
    match /company_executive_statements_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company news by ticker with history tracking
    // Public read and write (for development/testing)
    match /company_news_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Sense reports - users can read/write their own reports
    match /sense_reports/{userId}/{report=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Social Media Connections - main document pattern (userId_platform)
    // Structure: socialConnections/{userId}_{platform}
    //   with history subcollection: socialConnections/{userId}_{platform}/history/{timestamp}
    match /socialConnections/{connectionId} {
      // Extract userId from connectionId (format: userId_PLATFORM)
      // connectionId format: gbbfW038Vkejgq0mnzADpXtJVWK2_TWITTER

      // Users can read their own connections
      // connectionId starts with userId, so we can check without reading resource.data
      allow read: if request.auth != null
                  && connectionId.matches(request.auth.uid + '_.*');

      // Users can create/update connections (upsert pattern with setDoc merge)
      allow write: if request.auth != null
                   && connectionId.matches(request.auth.uid + '_.*')
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.platform in ['TWITTER', 'FACEBOOK', 'INSTAGRAM', 'LINKEDIN', 'TIKTOK']
                   && request.resource.data.handle is string
                   && request.resource.data.handle.size() > 0;

      // Users can delete their own connections
      allow delete: if request.auth != null
                    && connectionId.matches(request.auth.uid + '_.*');

      // History subcollection - users can read/write their own history
      match /history/{historyId} {
        allow read, write: if request.auth != null
                           && connectionId.matches(request.auth.uid + '_.*');
      }
    }

    // Entity Stances - user's explicit support/oppose on entities
    // Structure: entityStances/{userId}/entities/{entityName}
    match /entityStances/{userId}/entities/{entityName} {
      // Users can read/write only their own entity stances
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // News Prism Lens Feedback - user's stance selection on news perspectives
    // Structure: news_prism_lens/{newsDocId}/users_lens_records/{userId}
    // Main document stores news info and three stances
    // Subcollection stores user feedback
    match /news_prism_lens/{newsDocId} {
      // Authenticated users can read main document (for analytics)
      allow read: if request.auth != null;

      // Authenticated users can create main document (first user to provide feedback)
      allow create: if request.auth != null
                    && request.resource.data.newsId is string
                    && request.resource.data.newsTitle is string
                    && request.resource.data.support is string
                    && request.resource.data.neutral is string
                    && request.resource.data.oppose is string;

      // No updates or deletes to main document after creation
      allow update, delete: if false;

      // User feedback subcollection
      match /users_lens_records/{userId} {
        // Users can read/write only their own lens feedback
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Premium Subscription System
    // Structure: user_subscriptions/{userId} with history subcollection
    match /user_subscriptions/{userId} {
      // Users can read/write only their own subscription
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Billing history subcollection
      match /history/{historyId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if false; // History is append-only
      }
    }

    // Payment Methods - users can read/write their own payment info
    match /payment_methods/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Promotion Codes - authenticated users can read, write for validation
    match /promotion_codes/{codeId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null
                    && (!resource.data.isUsed || resource.data.isUsed == false)
                    && request.resource.data.isUsed == true
                    && request.resource.data.userId == request.auth.uid;
      allow create, delete: if false; // Admin only
    }

    // Revenue Collection - Cloud Functions write, authenticated users read
    match /revenue/{recordId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions (server-side via Admin SDK)
    }

    // Subscription Events - Users can write their own events, all authenticated users can read
    match /subscription_events/{eventId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Events are immutable
    }

    // User Locations - users can read/write only their own location data
    // Structure: userLocations/{userId} with history subcollection
    // Pattern: Main document stores current state, history/{timestamp} stores all changes
    match /userLocations/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // History subcollection - users can read/write their own location history
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // User Notifications - users can read/write only their own notification data
    // Structure: userNotifications/{userId} with history subcollection
    // Pattern: Main document stores current state, history/{timestamp} stores all changes
    match /userNotifications/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // History subcollection - users can read/write their own notification history
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // User Camera - users can read/write only their own camera permission data
    // Structure: userCamera/{userId} with history subcollection
    // Pattern: Main document stores current state, history/{timestamp} stores all changes
    match /userCamera/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // History subcollection - users can read/write their own camera history
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // User Persona Embeddings - users can read/write only their own persona embeddings
    // Structure: user_persona_embeddings/{userId} with history subcollection
    // Pattern: Main document stores current embedding, history/{timestamp} stores all versions
    match /user_persona_embeddings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // History subcollection - users can read/write their own embedding history
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ==================== Global Intelligence Map - Location Collections ====================

    // News Locations - AI-analyzed geographic locations from news articles
    // Public read for globe display, only Cloud Functions can write
    match /news_locations/{docId} {
      allow read: if true;  // Allow public read for globe markers
      allow write: if false; // Only Cloud Functions
    }

    // Breaking News Locations - AI-analyzed locations with severity assessment
    match /breaking_news_locations/{docId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions
    }

    // Conflict Zones - Global conflict monitoring data
    match /conflict_zones/{docId} {
      allow read: if request.auth != null;
      allow write: if false; // Only admins via Cloud Functions
    }

    // User Country Locations Subcollection - User's birth and current country coordinates
    // Structure: users/{userId}/users_countries_locations/{locationId}
    // Note: This is already covered by the users/{userId} match above, but we add explicit rules
    match /users/{userId} {
      // User countries locations subcollection
      match /users_countries_locations/{locationId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        // Cloud Functions can write, users can delete their own data (for account deletion)
        allow create, update: if false; // Only Cloud Functions can create/update
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ==================== StanseRadar China News Collection ====================
    // Special collection for another service in gen-lang-client-0960644135 project
    // This collection is isolated - only this collection is accessible by external service
    // Other collections (users, news, etc.) remain protected
    match /news_stanseradar_china/{document=**} {
      // Allow public read/write for development (will be restricted in production)
      // TODO: Replace with service account authentication for production
      allow read, write: if true;
    }

    // China News Consolidated - Generated broadcasts from news_stanseradar_china
    match /news_stanseradar_china_consolidated/{docId} {
      allow read: if true;  // All users can read
      allow write: if request.auth != null; // TEMP: Allow authenticated users for testing (will be restricted to Functions only in production)
    }

    // ==================== DUEL Arena System ====================

    // User Credits - Main document with current balance + history subcollection
    // Structure: user_credits/{userId} with history/{timestamp} for all transactions
    // Pattern: Main document auto-updates from latest history record
    match /user_credits/{userId} {
      // Users can read their own credits
      allow read: if request.auth != null && request.auth.uid == userId;
      // Only Cloud Functions can write to main document
      allow write: if false;

      // Credit history - append-only ledger
      match /history/{eventId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if false; // Only Cloud Functions can create
        allow update, delete: if false; // History is immutable
      }
    }

    // DUEL Questions - Public read, authenticated write (TEMPORARY for population)
    match /duel_questions/{questionId} {
      allow read: if true;
      allow write: if request.auth != null; // TEMP: Allow auth users to populate
    }

    // DUEL Question Sequences - Pre-assembled sequences for matches
    match /duel_sequences/{sequenceId} {
      allow read: if true;
      allow write: if request.auth != null; // TEMP: Allow auth users to populate
    }

    // DUEL Matchmaking Queue - Users can read/write their own queue entry
    match /duel_matchmaking_queue/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // DUEL Matches - Detailed match records with gameplay tracking
    // Structure: duel_matches/{matchId} with gameplay_events subcollection
    match /duel_matches/{matchId} {
      // Players can read their own matches (document-level access)
      allow get: if request.auth != null
                  && (resource.data.players.A.userId == request.auth.uid
                   || resource.data.players.B.userId == request.auth.uid);

      // Allow list/query access for authenticated users
      // The client query uses array-contains on participantIds to filter by userId
      // Security note: Users can only see their own matches via participantIds filter
      allow list: if request.auth != null;

      // Only Cloud Functions can create/update matches
      allow write: if false;

      // Gameplay events - detailed record of each question answered
      match /gameplay_events/{eventId} {
        allow read: if request.auth != null
                    && (get(/databases/$(database)/documents/duel_matches/$(matchId)).data.players.A.userId == request.auth.uid
                     || get(/databases/$(database)/documents/duel_matches/$(matchId)).data.players.B.userId == request.auth.uid);
        allow write: if false; // Only Cloud Functions
      }
    }

    // DUEL Platform Revenue - Track house earnings
    match /duel_platform_revenue/{recordId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions
    }

    // ==================== Active Fronts Campaign System ====================
    // Campaigns stored with main doc + history + participants pattern
    // Structure: union_ACTIVE_FRONTS/{campaignId} with history and participants subcollections
    match /union_ACTIVE_FRONTS/{campaignId} {
      // Anyone can read campaigns (public visibility)
      allow read: if true;

      // Authenticated users can write (for development/population)
      // TODO: Restrict to admin only in production
      allow write: if request.auth != null;

      // Campaign history - immutable snapshots
      match /history/{historyId} {
        allow read: if true;
        allow write: if request.auth != null; // System creates history on updates
      }

      // Campaign participants - user action records
      match /participants/{userId} {
        // Users can read their own participation
        allow read: if request.auth != null && request.auth.uid == userId;
        // Users can write their own participation
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Offline Activity Proposals - User-submitted proposals for events
    match /offline_activity_proposals/{proposalId} {
      // Authenticated users can read all proposals
      allow read: if request.auth != null;
      // Authenticated users can create proposals
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.status == 'pending';
      // Only admins can update (approve/reject)
      allow update: if request.auth != null;
      // No one can delete (keep records)
      allow delete: if false;
    }

    // ==================== AI Chat Assistant ====================
    // Chat History - users can read/write only their own chat history (max 5 records enforced client-side)
    // Structure: users/{userId}/chatHistory/{messageId}
    match /users/{userId}/chatHistory/{messageId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ==================== Ember AI Chat 成本追踪 ====================
    // 成本追踪 - Cloud Function (gen-lang-client-0960644135) 写入到 stanseproject
    // Structure: users/{userId}/ember_cost_sessions/{sessionId}
    match /users/{userId}/ember_cost_sessions/{sessionId} {
      // 用户可以读取自己的成本数据
      allow read: if request.auth != null && request.auth.uid == userId;
      // Cloud Function 可以写入（通过 Firebase Admin SDK）
      allow write: if true; // 暂时允许所有写入，生产环境应限制为 service account
    }

    // Ember 全局缓存 - Cloud Function 管理（所有用户共享）
    match /ember_global_cache/{cacheKey} {
      allow read: if request.auth != null; // 认证用户可读
      allow write: if true; // Cloud Function 写入
    }

    // Ember 用户预算设置
    match /user_budgets/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Ember 用户等级
    match /user_tiers/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // 仅管理员可修改
    }

    // ==================== Market Analysis Cache ====================
    // 市场分析缓存 - 用户只能读写自己的分析缓存
    // Structure: users/{userId}/market_analysis_cache/{language}
    // 缓存每种语言的 Today's Analysis，减少 API 调用
    match /users/{userId}/market_analysis_cache/{language} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ==================== Enhanced Persona Index Long/Short Fund ====================
    // Portfolio return tracking for each persona's long/short strategy
    // Written by Cloud Run Job (gen-lang-client-0960644135), read by all authenticated users
    // Structure: enhanced_persona_index_longshort_fund/{stanceType} with snapshots subcollection
    // Data includes: portfolioReturn, longReturn, shortReturn, positions (10 stocks with prices)
    match /enhanced_persona_index_longshort_fund/{stanceType} {
      // TEMP: Allow public read for testing chart
      allow read: if true;
      // Only Cloud Functions/Cloud Run can write (via Admin SDK)
      allow write: if true;  // TEMP: Allow for Cloud Run Job (uses Admin SDK with service account)

      // Historical snapshots - immutable record of each tracking point
      match /snapshots/{snapshotId} {
        // TEMP: Allow public read for testing chart
        allow read: if true;
        allow write: if true;  // TEMP: Allow for Cloud Run Job
      }
    }

    // Public read for certain collections
    match /public_data/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // 默认拒绝所有
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
