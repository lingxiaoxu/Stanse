rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // 用户数据 - 只有认证用户可以读写自己的数据
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Polis Protocol user data
    match /polis_users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // User actions - users can read/write their own actions
    match /user_actions/{actionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // FEC 公开数据 - 所有人可读，禁止写入

    // Multi-year collections (包含所有年份的数据)
    match /fec_raw_committees/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_candidates/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_linkages/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_transfers/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Year-specific contribution collections (每个年份一个独立集合)
    // Collection names use short year format: _24, _22, _20, _18, _16
    match /fec_raw_contributions_pac_to_candidate_24/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_22/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_20/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_18/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_raw_contributions_pac_to_candidate_16/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Company indexes and summaries
    match /fec_company_index/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_company_party_summary/{docId} {
      allow read: if true;
      allow write: if false;
    }

    match /fec_company_name_variants/{docId} {
      allow read: if true;
      allow write: if request.auth != null;  // Authenticated users can update variants with AI
    }

    match /fec_company_consolidated/{docId} {
      allow read: if true;
      allow write: if false;  // Read-only for clients
    }

    // Polis Protocol 数据 - 需要认证
    match /polis_transactions/{txId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // 新闻和更新 - 公开读，管理员写，但也允许认证用户缓存
    match /news/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 新闻图片缓存 - 认证用户可以读写
    match /news_images/{document=**} {
      allow read, write: if request.auth != null;
    }

    // 新闻向量嵌入缓存 - 认证用户可以读写
    match /news_embeddings/{document=**} {
      allow read, write: if request.auth != null;
    }

    // 公司排名缓存 - DEPRECATED, use enhanced_company_rankings instead
    // Allow public read/write for backward compatibility during migration
    match /company_rankings/{document=**} {
      allow read: if true;
      allow write: if true;  // Allow public write for development/migration
    }

    // Enhanced company rankings with persona-aware scoring (including history subcollection)
    // Public read and write (for development/testing - frontend can generate rankings)
    match /enhanced_company_rankings/{persona} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company rankings by ticker (FEC + ESG + Executive + News data)
    // Public read and write (for development/testing - backend scripts can write)
    match /company_rankings_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company ESG data by ticker with history tracking
    // Public read and write (for development/testing)
    match /company_esg_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company executive statements by ticker with history tracking
    // Public read and write (for development/testing)
    match /company_executive_statements_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Company news by ticker with history tracking
    // Public read and write (for development/testing)
    match /company_news_by_ticker/{ticker} {
      allow read: if true;
      allow write: if true;  // Allow public write for development

      // History subcollection
      match /history/{historyId} {
        allow read: if true;
        allow write: if true;  // Allow public write for development
      }
    }

    // Sense reports - users can read/write their own reports
    match /sense_reports/{userId}/{report=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Social Media Connections - main document pattern (userId_platform)
    // Structure: socialConnections/{userId}_{platform}
    //   with history subcollection: socialConnections/{userId}_{platform}/history/{timestamp}
    match /socialConnections/{connectionId} {
      // Extract userId from connectionId (format: userId_PLATFORM)
      // connectionId format: gbbfW038Vkejgq0mnzADpXtJVWK2_TWITTER

      // Users can read their own connections
      // connectionId starts with userId, so we can check without reading resource.data
      allow read: if request.auth != null
                  && connectionId.matches(request.auth.uid + '_.*');

      // Users can create/update connections (upsert pattern with setDoc merge)
      allow write: if request.auth != null
                   && connectionId.matches(request.auth.uid + '_.*')
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.platform in ['TWITTER', 'FACEBOOK', 'INSTAGRAM', 'LINKEDIN', 'TIKTOK']
                   && request.resource.data.handle is string
                   && request.resource.data.handle.size() > 0;

      // Users can delete their own connections
      allow delete: if request.auth != null
                    && connectionId.matches(request.auth.uid + '_.*');

      // History subcollection - users can read/write their own history
      match /history/{historyId} {
        allow read, write: if request.auth != null
                           && connectionId.matches(request.auth.uid + '_.*');
      }
    }

    // Entity Stances - user's explicit support/oppose on entities
    // Structure: entityStances/{userId}/entities/{entityName}
    match /entityStances/{userId}/entities/{entityName} {
      // Users can read/write only their own entity stances
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Premium Subscription System
    // Structure: user_subscriptions/{userId} with history subcollection
    match /user_subscriptions/{userId} {
      // Users can read/write only their own subscription
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Billing history subcollection
      match /history/{historyId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow update, delete: if false; // History is append-only
      }
    }

    // Payment Methods - users can read/write their own payment info
    match /payment_methods/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Promotion Codes - authenticated users can read, write for validation
    match /promotion_codes/{codeId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null
                    && (!resource.data.isUsed || resource.data.isUsed == false)
                    && request.resource.data.isUsed == true
                    && request.resource.data.userId == request.auth.uid;
      allow create, delete: if false; // Admin only
    }

    // Revenue Collection - Cloud Functions write, authenticated users read
    match /revenue/{recordId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions (server-side via Admin SDK)
    }

    // Subscription Events - Users can write their own events, all authenticated users can read
    match /subscription_events/{eventId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Events are immutable
    }

    // User Locations - users can read/write only their own location data
    // Structure: userLocations/{userId} with history subcollection
    // Pattern: Main document stores current state, history/{timestamp} stores all changes
    match /userLocations/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // History subcollection - users can read/write their own location history
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // User Notifications - users can read/write only their own notification data
    // Structure: userNotifications/{userId} with history subcollection
    // Pattern: Main document stores current state, history/{timestamp} stores all changes
    match /userNotifications/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // History subcollection - users can read/write their own notification history
      match /history/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Public read for certain collections
    match /public_data/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // 默认拒绝所有
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
