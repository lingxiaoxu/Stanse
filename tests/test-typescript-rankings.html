<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test TypeScript Rankings Generation</title>
    <style>
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #569cd6;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 8px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #1177bb;
        }
        button:disabled {
            background: #3c3c3c;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            height: 500px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #569cd6;
            padding-left: 10px;
        }
        .log-entry.success {
            border-left-color: #4ec9b0;
        }
        .log-entry.error {
            border-left-color: #f48771;
            color: #f48771;
        }
        .log-entry.warning {
            border-left-color: #dcdcaa;
            color: #dcdcaa;
        }
        .persona-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .persona-item {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #569cd6;
        }
        .persona-item.completed {
            border-left-color: #4ec9b0;
        }
        .persona-item.failed {
            border-left-color: #f48771;
        }
        .persona-item.running {
            border-left-color: #dcdcaa;
        }
    </style>
</head>
<body>
    <h1>üéØ TypeScript Rankings Generation Test</h1>

    <div class="controls">
        <button id="generateAll" onclick="generateAllPersonas()">Generate All 8 Personas</button>
        <button onclick="exportDetailedJSON()">Export JSON</button>
        <button onclick="exportDetailedCSV()">Export CSV</button>
        <button id="clearLogs" onclick="clearLogs()">Clear Logs</button>
        <span id="status" style="margin-left: 20px; color: #dcdcaa;"></span>
    </div>

    <div id="personaStatus" class="persona-list"></div>

    <div class="log" id="logContainer"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyANw78F5I3fP3cQaZaF8cSQzH5M5m7hnZc",
            authDomain: "stanseproject.firebaseapp.com",
            projectId: "stanseproject",
            storageBucket: "stanseproject.firebasestorage.app",
            messagingSenderId: "825661706911",
            appId: "1:825661706911:web:9c140a64fcbbbd1e95f359"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make db globally available
        window.firebaseDb = db;

        log('‚úÖ Firebase initialized successfully', 'success');
        log('üìä Ready to generate rankings', 'success');
    </script>

    <script type="module">
        import { rankCompaniesForStanceEnhanced } from '../services/companyRankingService.ts';

        const ALL_PERSONAS = [
            'progressive-globalist',
            'progressive-nationalist',
            'socialist-libertarian',
            'socialist-nationalist',
            'capitalist-globalist',
            'capitalist-nationalist',
            'conservative-globalist',
            'conservative-nationalist'
        ];

        let personaStatus = {};

        function initPersonaStatus() {
            const container = document.getElementById('personaStatus');
            container.innerHTML = '';

            ALL_PERSONAS.forEach(persona => {
                personaStatus[persona] = 'pending';
                const div = document.createElement('div');
                div.className = 'persona-item';
                div.id = `persona-${persona}`;
                div.innerHTML = `
                    <div style="font-weight: bold;">${persona}</div>
                    <div id="status-${persona}" style="font-size: 11px; margin-top: 5px; color: #858585;">‚è≥ Pending</div>
                `;
                container.appendChild(div);
            });
        }

        function updatePersonaStatus(persona, status, message) {
            personaStatus[persona] = status;
            const div = document.getElementById(`persona-${persona}`);
            const statusDiv = document.getElementById(`status-${persona}`);

            div.className = `persona-item ${status}`;

            const icons = {
                running: '‚öôÔ∏è',
                completed: '‚úÖ',
                failed: '‚ùå'
            };

            statusDiv.textContent = `${icons[status]} ${message}`;
        }

        // Store detailed calculation logs for all personas
        window.detailedCalculationLogs = {};

        window.generateAllPersonas = async function() {
            const button = document.getElementById('generateAll');
            const statusSpan = document.getElementById('status');

            button.disabled = true;
            initPersonaStatus();

            log('üöÄ Starting TypeScript rankings generation for all 8 personas...', 'success');
            const startTime = Date.now();

            let successCount = 0;
            let failCount = 0;

            for (const persona of ALL_PERSONAS) {
                try {
                    updatePersonaStatus(persona, 'running', 'Generating...');
                    statusSpan.textContent = `Generating: ${persona}`;
                    log(`\n${'='.repeat(60)}`);
                    log(`üéØ Generating ranking for: ${persona}`);
                    log(`${'='.repeat(60)}`);

                    // Capture ALL console.log messages to extract detailed calculation info
                    const calculationLogs = [];
                    const originalLog = console.log;
                    const originalError = console.error;

                    console.log = (...args) => {
                        originalLog(...args);
                        const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                        calculationLogs.push(message);

                        // Show important logs
                        if (message.includes('[Firebase]') || message.includes('[AI-Data]') || message.includes('[LLM')) {
                            log(message, message.includes('Error') ? 'error' : 'success');
                        }
                    };

                    console.error = (...args) => {
                        originalError(...args);
                        const message = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                        calculationLogs.push(`ERROR: ${message}`);
                        log(`üî¥ ${message}`, 'error');
                    };

                    const result = await rankCompaniesForStanceEnhanced(persona, true);

                    // Restore console
                    console.log = originalLog;
                    console.error = originalError;

                    // Store detailed logs for this persona
                    window.detailedCalculationLogs[persona] = calculationLogs;

                    // Parse and log detailed calculation information
                    const detailedInfo = parseDetailedCalculations(persona, calculationLogs);

                    log(`‚úÖ Successfully generated ranking for ${persona}`, 'success');
                    log(`   - Support companies: ${result.supportCompanies.length}`, 'success');
                    log(`   - Oppose companies: ${result.opposeCompanies.length}`, 'success');
                    log(`   - AI-Data mode: ${detailedInfo.aiDataCount} companies`, 'success');
                    log(`   - LLM-only mode: ${detailedInfo.llmOnlyCount} companies`, 'success');

                    updatePersonaStatus(persona, 'completed', `‚úì Completed (${result.supportCompanies.length} support, ${result.opposeCompanies.length} oppose)`);
                    successCount++;

                } catch (error) {
                    log(`‚ùå Error generating ranking for ${persona}: ${error.message}`, 'error');
                    log(`   Stack: ${error.stack}`, 'error');
                    console.error(error);
                    updatePersonaStatus(persona, 'failed', `‚úó Failed: ${error.message}`);
                    failCount++;
                }
            }

            const duration = ((Date.now() - startTime) / 1000).toFixed(1);

            log(`\n${'='.repeat(60)}`);
            log(`‚úÖ Generation Complete`, 'success');
            log(`${'='.repeat(60)}`);
            log(`Duration: ${duration}s (${(duration/60).toFixed(1)} minutes)`);
            log(`\nüìä Results:`);
            log(`  ‚úÖ Success: ${successCount}`);
            if (failCount > 0) {
                log(`  ‚ùå Failed: ${failCount}`, 'error');
            }
            log(`${'='.repeat(60)}\n`);

            button.disabled = false;
            statusSpan.textContent = `Completed: ${successCount}/${ALL_PERSONAS.length} successful`;
        };

        window.log = function(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        };

        window.clearLogs = function() {
            document.getElementById('logContainer').innerHTML = '';
        };

        /**
         * Parse detailed calculation information from logs
         */
        function parseDetailedCalculations(persona, logs) {
            const companyData = {};
            let aiDataCount = 0;
            let llmOnlyCount = 0;

            logs.forEach(log => {
                // Extract AI-Data mode calculations
                const aiDataMatch = log.match(/\[AI-Data\] (\w+): Numerical=([\d.]+), LLM=([\d.]+), Final=([\d.]+)/);
                if (aiDataMatch) {
                    const [_, ticker, numerical, llm, final] = aiDataMatch;
                    if (!companyData[ticker]) companyData[ticker] = {};
                    companyData[ticker].mode = 'ai-data';
                    companyData[ticker].numericalScore = parseFloat(numerical);
                    companyData[ticker].llmScore = parseFloat(llm);
                    companyData[ticker].finalScore = parseFloat(final);
                    aiDataCount++;
                }

                // Extract numerical component details - look for FEC, ESG, Exec, News scores
                const numericalDetailMatch = log.match(/(\w+).*Numerical: FEC=([\d.]+|N\/A), ESG=([\d.]+|N\/A), Exec=([\d.]+|N\/A), News=([\d.]+|N\/A)/);
                if (numericalDetailMatch) {
                    const [_, ticker, fec, esg, exec, news] = numericalDetailMatch;
                    if (!companyData[ticker]) companyData[ticker] = {};
                    companyData[ticker].fecScore = fec === 'N/A' ? null : parseFloat(fec);
                    companyData[ticker].esgScore = esg === 'N/A' ? null : parseFloat(esg);
                    companyData[ticker].executiveScore = exec === 'N/A' ? null : parseFloat(exec);
                    companyData[ticker].newsScore = news === 'N/A' ? null : parseFloat(news);
                }

                // Extract LLM comprehensive reasoning
                const llmMatch = log.match(/\[LLM Comprehensive\] (\w+): Score=([\d.]+), Reasoning="(.+?)"/);
                if (llmMatch) {
                    const [_, ticker, score, reasoning] = llmMatch;
                    if (!companyData[ticker]) companyData[ticker] = {};
                    companyData[ticker].llmReasoning = reasoning;
                }
            });

            llmOnlyCount = Object.keys(companyData).length - aiDataCount;

            return {
                aiDataCount,
                llmOnlyCount,
                companyData
            };
        }

        /**
         * Export detailed calculation logs to JSON
         */
        window.exportDetailedJSON = function() {
            if (Object.keys(window.detailedCalculationLogs).length === 0) {
                alert('No calculation logs available. Please generate rankings first.');
                return;
            }

            // Parse all logs
            const detailedReport = {};
            ALL_PERSONAS.forEach(persona => {
                if (window.detailedCalculationLogs[persona]) {
                    const parsed = parseDetailedCalculations(persona, window.detailedCalculationLogs[persona]);
                    detailedReport[persona] = {
                        aiDataCount: parsed.aiDataCount,
                        llmOnlyCount: parsed.llmOnlyCount,
                        companies: parsed.companyData
                    };
                }
            });

            // Generate downloadable JSON
            const dataStr = JSON.stringify(detailedReport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `typescript-detailed-calculations-${Date.now()}.json`;
            link.click();

            log('‚úÖ Exported detailed calculation logs to JSON', 'success');
        };

        /**
         * Export detailed calculation logs as CSV
         */
        window.exportDetailedCSV = function() {
            if (Object.keys(window.detailedCalculationLogs).length === 0) {
                alert('No calculation logs available. Please generate rankings first.');
                return;
            }

            const rows = [];
            rows.push(['Persona', 'Ticker', 'Mode', 'FEC Score', 'ESG Score', 'Executive Score', 'News Score', 'Numerical Score', 'LLM Score', 'Final Score', 'LLM Reasoning']);

            ALL_PERSONAS.forEach(persona => {
                if (window.detailedCalculationLogs[persona]) {
                    const parsed = parseDetailedCalculations(persona, window.detailedCalculationLogs[persona]);

                    Object.entries(parsed.companyData).forEach(([ticker, data]) => {
                        rows.push([
                            persona,
                            ticker,
                            data.mode || 'llm-only',
                            data.fecScore !== undefined && data.fecScore !== null ? data.fecScore.toFixed(2) : 'N/A',
                            data.esgScore !== undefined && data.esgScore !== null ? data.esgScore.toFixed(2) : 'N/A',
                            data.executiveScore !== undefined && data.executiveScore !== null ? data.executiveScore.toFixed(2) : 'N/A',
                            data.newsScore !== undefined && data.newsScore !== null ? data.newsScore.toFixed(2) : 'N/A',
                            data.numericalScore !== undefined ? data.numericalScore.toFixed(2) : 'N/A',
                            data.llmScore !== undefined ? data.llmScore.toFixed(2) : 'N/A',
                            data.finalScore !== undefined ? data.finalScore.toFixed(2) : 'N/A',
                            (data.llmReasoning || '').replace(/"/g, '""') // Escape quotes
                        ]);
                    });
                }
            });

            const csvContent = rows.map(row => row.join(',')).join('\n');
            const csvBlob = new Blob([csvContent], {type: 'text/csv'});
            const url = URL.createObjectURL(csvBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `typescript-detailed-calculations-${Date.now()}.csv`;
            link.click();

            log('‚úÖ Exported detailed calculation logs to CSV', 'success');
        };

        // Make functions globally available
        window.rankCompaniesForStanceEnhanced = rankCompaniesForStanceEnhanced;

        // Initialize persona status on load
        initPersonaStatus();
    </script>
</body>
</html>
