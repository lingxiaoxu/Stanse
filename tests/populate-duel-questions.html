<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DUEL Arena - Question Manager</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      padding: 40px;
      background: #0a0a0a;
      color: #00ff00;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #00ff00;
      border-bottom: 2px solid #00ff00;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    h2 { color: #00cc00; margin-top: 30px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #111;
      border: 1px solid #00ff00;
      padding: 20px;
      text-align: center;
    }
    .stat-card .number {
      font-size: 48px;
      font-weight: bold;
      color: #00ff00;
    }
    .stat-card .label {
      color: #888;
      margin-top: 5px;
    }
    .stat-card.easy .number { color: #86efac; }
    .stat-card.medium .number { color: #fde047; }
    .stat-card.hard .number { color: #fca5a5; }

    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    button {
      padding: 15px 30px;
      font-size: 16px;
      background: #00ff00;
      color: #000;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-family: inherit;
      transition: all 0.2s;
    }
    button:hover {
      background: #00cc00;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
      transform: none;
    }
    button.danger {
      background: #ff4444;
      color: #fff;
    }
    button.danger:hover {
      background: #cc0000;
    }
    button.secondary {
      background: #333;
      color: #00ff00;
      border: 1px solid #00ff00;
    }
    button.secondary:hover {
      background: #00ff00;
      color: #000;
    }

    #output {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #111;
      border: 1px solid #333;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
    }

    .questions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    .questions-table th,
    .questions-table td {
      border: 1px solid #333;
      padding: 10px;
      text-align: left;
    }
    .questions-table th {
      background: #1a1a1a;
      color: #00ff00;
    }
    .questions-table tr:hover {
      background: #1a1a1a;
    }
    .difficulty-easy { color: #86efac; }
    .difficulty-medium { color: #fde047; }
    .difficulty-hard { color: #fca5a5; }

    .sample-images {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .sample-images img {
      width: 120px;
      height: 120px;
      border: 2px solid #333;
      object-fit: cover;
    }
    .sample-images img.correct {
      border-color: #00ff00;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #00ff00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>DUEL Arena - Question Manager</h1>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="number" id="totalCount">-</div>
      <div class="label">Total Questions</div>
    </div>
    <div class="stat-card easy">
      <div class="number" id="easyCount">-</div>
      <div class="label">Easy</div>
    </div>
    <div class="stat-card medium">
      <div class="number" id="mediumCount">-</div>
      <div class="label">Medium</div>
    </div>
    <div class="stat-card hard">
      <div class="number" id="hardCount">-</div>
      <div class="label">Hard</div>
    </div>
  </div>

  <h2>Login</h2>
  <div id="loginSection" style="margin-bottom: 20px; padding: 15px; background: #111; border: 1px solid #333;">
    <div id="loginForm">
      <input type="email" id="emailInput" placeholder="Email" style="padding: 10px; margin-right: 10px; background: #222; border: 1px solid #444; color: #0f0; width: 200px;">
      <input type="password" id="passwordInput" placeholder="Password" style="padding: 10px; margin-right: 10px; background: #222; border: 1px solid #444; color: #0f0; width: 150px;">
      <button onclick="doLogin()" id="loginBtn">Login</button>
    </div>
    <div id="loggedInAs" style="display: none; color: #0f0;">
      Logged in as: <span id="userEmail"></span>
      <button onclick="doLogout()" class="secondary" style="margin-left: 15px; padding: 8px 15px;">Logout</button>
    </div>
  </div>

  <h2>Actions</h2>
  <div class="button-group">
    <button onclick="loadStats()" id="refreshBtn">Refresh Stats</button>
    <button onclick="uploadQuestions()" id="uploadBtn" disabled>Upload 150 Questions</button>
    <button onclick="clearQuestions()" class="danger" id="clearBtn" disabled>Clear All Questions</button>
    <button onclick="viewSample()" class="secondary" id="sampleBtn">View Sample Question</button>
  </div>

  <div style="margin-top: 20px; padding: 15px; background: #1a1a00; border: 1px solid #666600; color: #cccc00;">
    <strong>Note:</strong> Upload/Clear require login. Or use CLI:<br>
    <code style="display: block; margin-top: 10px; padding: 10px; background: #000; color: #0f0;">
      node scripts/duel/upload-complete-questions.mjs
    </code>
  </div>

  <div id="output"></div>

  <div id="sampleSection" class="hidden">
    <h2>Sample Question</h2>
    <div id="sampleContent"></div>
  </div>

  <div id="questionsSection" class="hidden">
    <h2>Questions by Category</h2>
    <div id="categoryStats"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, writeBatch, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD1Hdjo17l2YrgakNzZW-lpx78vVE77keE",
      authDomain: "stanseproject.firebaseapp.com",
      projectId: "stanseproject",
      storageBucket: "stanseproject.firebasestorage.app",
      messagingSenderId: "626045766180",
      appId: "1:626045766180:web:3a8d3967343cc3264ca6b1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isAuthenticated = false;

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      const loginForm = document.getElementById('loginForm');
      const loggedInAs = document.getElementById('loggedInAs');
      const userEmail = document.getElementById('userEmail');
      const uploadBtn = document.getElementById('uploadBtn');
      const clearBtn = document.getElementById('clearBtn');

      if (user) {
        isAuthenticated = true;
        loginForm.style.display = 'none';
        loggedInAs.style.display = 'block';
        userEmail.textContent = user.email;
        uploadBtn.disabled = false;
        clearBtn.disabled = false;
        log('Authenticated as: ' + user.email, 'success');
      } else {
        isAuthenticated = false;
        loginForm.style.display = 'block';
        loggedInAs.style.display = 'none';
        userEmail.textContent = '';
        uploadBtn.disabled = true;
        clearBtn.disabled = true;
        log('Not logged in (read-only mode)');
      }
      // Load stats regardless of auth status
      loadStats();
    });

    // Login function
    window.doLogin = async function() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      const loginBtn = document.getElementById('loginBtn');

      if (!email || !password) {
        log('Please enter email and password', 'error');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      log('Attempting login...');

      try {
        await signInWithEmailAndPassword(auth, email, password);
        log('Login successful!', 'success');
      } catch (error) {
        log('Login failed: ' + error.message, 'error');
      }

      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
    };

    // Logout function
    window.doLogout = async function() {
      try {
        await auth.signOut();
        log('Logged out', 'success');
      } catch (error) {
        log('Logout error: ' + error.message, 'error');
      }
    };

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : '>';
      output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    function setLoading(btnId, loading) {
      const btn = document.getElementById(btnId);
      btn.disabled = loading;
    }

    // Load stats from Firestore
    window.loadStats = async function() {
      setLoading('refreshBtn', true);
      log('Loading question stats...');

      try {
        const snapshot = await getDocs(collection(db, 'duel_questions'));

        const stats = { total: 0, EASY: 0, MEDIUM: 0, HARD: 0 };
        const categories = {};

        snapshot.forEach(doc => {
          const data = doc.data();
          stats.total++;
          stats[data.difficulty]++;
          categories[data.category] = (categories[data.category] || 0) + 1;
        });

        document.getElementById('totalCount').textContent = stats.total;
        document.getElementById('easyCount').textContent = stats.EASY;
        document.getElementById('mediumCount').textContent = stats.MEDIUM;
        document.getElementById('hardCount').textContent = stats.HARD;

        // Show category breakdown
        if (stats.total > 0) {
          document.getElementById('questionsSection').classList.remove('hidden');
          let catHtml = '<table class="questions-table"><tr><th>Category</th><th>Count</th></tr>';
          for (const [cat, count] of Object.entries(categories).sort()) {
            catHtml += `<tr><td>${cat}</td><td>${count}</td></tr>`;
          }
          catHtml += '</table>';
          document.getElementById('categoryStats').innerHTML = catHtml;
        }

        log(`Loaded: ${stats.total} questions (${stats.EASY} easy, ${stats.MEDIUM} medium, ${stats.HARD} hard)`, 'success');
      } catch (error) {
        log('Error loading stats: ' + error.message, 'error');
      }

      setLoading('refreshBtn', false);
    };

    // View sample question
    window.viewSample = async function() {
      setLoading('sampleBtn', true);
      log('Loading sample question...');

      try {
        const q = query(collection(db, 'duel_questions'), limit(1));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          log('No questions found', 'error');
          return;
        }

        const data = snapshot.docs[0].data();
        document.getElementById('sampleSection').classList.remove('hidden');

        let html = `
          <table class="questions-table">
            <tr><th>ID</th><td>${data.questionId}</td></tr>
            <tr><th>Stem</th><td>${data.stem}</td></tr>
            <tr><th>Category</th><td>${data.category}</td></tr>
            <tr><th>Difficulty</th><td class="difficulty-${data.difficulty.toLowerCase()}">${data.difficulty}</td></tr>
            <tr><th>Correct Index</th><td>${data.correctIndex}</td></tr>
          </table>
          <h3>Images</h3>
          <div class="sample-images">
        `;

        data.images.forEach((img, i) => {
          html += `<img src="${img.url}" alt="Option ${i}" class="${img.isCorrect ? 'correct' : ''}" title="${img.prompt}">`;
        });

        html += '</div>';
        document.getElementById('sampleContent').innerHTML = html;

        log('Sample question loaded: ' + data.questionId, 'success');
      } catch (error) {
        log('Error loading sample: ' + error.message, 'error');
      }

      setLoading('sampleBtn', false);
    };

    // Upload questions from JSON
    window.uploadQuestions = async function() {
      if (!confirm('This will clear existing questions and upload 150 new ones. Continue?')) {
        return;
      }

      setLoading('uploadBtn', true);
      log('Fetching question data...');

      try {
        // Fetch the JSON file
        const response = await fetch('/scripts/duel/complete-questions.json');
        if (!response.ok) {
          throw new Error('Could not load questions JSON. Make sure you run this from the project root with a local server.');
        }

        const questions = await response.json();
        log(`Loaded ${questions.length} questions from JSON`);

        // Clear existing
        log('Clearing existing questions...');
        const existingSnapshot = await getDocs(collection(db, 'duel_questions'));

        for (const docSnapshot of existingSnapshot.docs) {
          await deleteDoc(docSnapshot.ref);
        }
        log(`Cleared ${existingSnapshot.size} existing questions`);

        // Upload new questions
        log('Uploading new questions...');
        let count = 0;

        for (const q of questions) {
          const allOptions = [
            { description: q.correct, isCorrect: true },
            ...q.distractors.map(d => ({ description: d, isCorrect: false }))
          ];

          // Shuffle options
          const shuffled = allOptions
            .map((value) => ({ value, sort: Math.random() }))
            .sort((a, b) => a.sort - b.sort);

          const correctIndex = shuffled.findIndex(item => item.value.isCorrect);

          // Generate images array
          const colors = {
            EASY: ['86efac', '4ade80', '22c55e', '16a34a'],
            MEDIUM: ['fde047', 'facc15', 'eab308', 'ca8a04'],
            HARD: ['fca5a5', 'f87171', 'ef4444', 'dc2626']
          };

          const images = shuffled.map((item, idx) => {
            const color = colors[q.difficulty][idx % 4];
            const shortText = item.value.description.substring(0, 25).replace(/[^a-zA-Z0-9 ]/g, '');
            return {
              url: `https://placehold.co/512x512/${color}/000000?text=${encodeURIComponent(shortText)}`,
              isCorrect: item.value.isCorrect,
              prompt: item.value.description,
              index: idx,
              generatedAt: new Date().toISOString()
            };
          });

          const questionDoc = {
            questionId: q.id,
            stem: q.stem,
            category: q.category,
            difficulty: q.difficulty,
            images: images,
            correctIndex: correctIndex,
            createdAt: new Date().toISOString(),
            metadata: {
              imageGenModel: 'placeholder-v2',
              imageSize: '512x512',
              stylePrompt: 'Educational trivia image',
              generatedBy: 'web-uploader'
            }
          };

          await setDoc(doc(db, 'duel_questions', q.id), questionDoc);
          count++;

          if (count % 25 === 0) {
            log(`Uploaded ${count}/${questions.length}...`);
          }
        }

        log(`Successfully uploaded ${count} questions!`, 'success');
        loadStats();

      } catch (error) {
        log('Upload error: ' + error.message, 'error');
        console.error(error);
      }

      setLoading('uploadBtn', false);
    };

    // Clear all questions
    window.clearQuestions = async function() {
      if (!confirm('Are you sure you want to DELETE ALL questions? This cannot be undone!')) {
        return;
      }

      setLoading('clearBtn', true);
      log('Clearing all questions...');

      try {
        const snapshot = await getDocs(collection(db, 'duel_questions'));

        for (const docSnapshot of snapshot.docs) {
          await deleteDoc(docSnapshot.ref);
        }

        log(`Deleted ${snapshot.size} questions`, 'success');
        loadStats();

      } catch (error) {
        log('Clear error: ' + error.message, 'error');
      }

      setLoading('clearBtn', false);
    };
  </script>
</body>
</html>
