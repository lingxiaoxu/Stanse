<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Rankings Integration Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border: 3px solid #000;
      padding: 20px;
      margin-bottom: 20px;
    }
    h1, h2 {
      font-weight: bold;
      margin: 0 0 15px 0;
    }
    .test-section {
      margin-bottom: 30px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #000;
    }
    .status {
      display: inline-block;
      padding: 2px 8px;
      margin-left: 10px;
      font-size: 12px;
      border-radius: 3px;
    }
    .status.loading {
      background: #fef3c7;
      color: #92400e;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .log {
      background: #1f2937;
      color: #10b981;
      padding: 10px;
      font-size: 12px;
      overflow-x: auto;
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    .company-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .company-card {
      border: 2px solid #000;
      padding: 10px;
      background: white;
    }
    .company-card.support {
      border-color: #10b981;
      background: #d1fae5;
    }
    .company-card.oppose {
      border-color: #ef4444;
      background: #fee2e2;
    }
    button {
      background: #000;
      color: white;
      border: none;
      padding: 10px 20px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .persona-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .persona-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ccc;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .persona-btn:hover {
      border-color: #000;
      background: #f9f9f9;
    }
    .persona-btn.active {
      background: #000;
      color: white;
      border-color: #000;
    }
    .info {
      padding: 10px;
      background: #dbeafe;
      border-left: 4px solid #2563eb;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Enhanced Company Rankings Integration Test</h1>
    <p style="color: #666; margin-bottom: 20px;">
      Testing the new enhanced_company_rankings Firebase integration.<br>
      This verifies Python-generated rankings are being read correctly, with fallback to TypeScript calculation.
    </p>

    <div class="info">
      <strong>üìã Test Flow:</strong><br>
      1. Try to fetch pre-computed ranking from <code>enhanced_company_rankings</code> (Python, updated every 12h)<br>
      2. If not exists or expired, fallback to TypeScript real-time calculation<br>
      3. Display results with metadata (source, timestamp, etc.)
    </div>

    <!-- Persona Selector -->
    <div class="test-section">
      <h2>Select Persona</h2>
      <div class="persona-selector" id="personaSelector"></div>
    </div>

    <!-- Test Controls -->
    <div class="test-section">
      <h2>Test Controls</h2>
      <button onclick="testFetchRanking(false)">Fetch Ranking (Use Cache)</button>
      <button onclick="testFetchRanking(true)">Force Refresh (Skip Cache)</button>
      <button onclick="testCheckValidity()">Check Cache Validity</button>
      <button onclick="testGetAge()">Get Ranking Age</button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <!-- Results Display -->
    <div class="test-section">
      <h2>Results <span id="status" class="status loading">Ready</span></h2>
      <div id="metadata" style="margin-bottom: 15px;"></div>
      <div class="company-list" id="companies"></div>
    </div>

    <!-- Console Logs -->
    <div class="test-section">
      <h2>Console Logs</h2>
      <div class="log" id="logs"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDMQLJ59EXdHcObvxP3nfCRjqC-jRgx2iY",
      authDomain: "stanseproject.firebaseapp.com",
      projectId: "stanseproject",
      storageBucket: "stanseproject.firebasestorage.app",
      messagingSenderId: "626045766180",
      appId: "1:626045766180:web:9ae9aa1d9a60c76a0b8c09",
      measurementId: "G-XZGXQBHZ9S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make db available globally
    window.db = db;

    // Log initialization
    console.log('‚úÖ Firebase initialized');
    if (typeof log === 'function') {
      log('‚úÖ Firebase initialized successfully', 'success');
    }
  </script>

  <script>
    const PERSONAS = [
      'progressive-globalist',
      'progressive-nationalist',
      'socialist-libertarian',
      'socialist-nationalist',
      'capitalist-globalist',
      'capitalist-nationalist',
      'conservative-globalist',
      'conservative-nationalist'
    ];

    let selectedPersona = 'capitalist-globalist';

    // Initialize persona selector
    function initPersonaSelector() {
      const selector = document.getElementById('personaSelector');
      PERSONAS.forEach(persona => {
        const btn = document.createElement('button');
        btn.className = 'persona-btn' + (persona === selectedPersona ? ' active' : '');
        btn.textContent = persona;
        btn.onclick = () => {
          selectedPersona = persona;
          document.querySelectorAll('.persona-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          log(`Selected persona: ${persona}`, 'info');
        };
        selector.appendChild(btn);
      });
    }

    function log(message, type = 'info') {
      const logs = document.getElementById('logs');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#60a5fa';
      logs.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
      logs.scrollTop = logs.scrollHeight;
      console.log(message);
    }

    function setStatus(text, type) {
      const status = document.getElementById('status');
      status.textContent = text;
      status.className = 'status ' + type;
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      log('Logs cleared');
    }

    async function testFetchRanking(forceRefresh) {
      try {
        setStatus('Loading...', 'loading');
        log(`\n${'='.repeat(60)}`);
        log(`üéØ Fetching ranking for: ${selectedPersona} (forceRefresh: ${forceRefresh})`);

        // Direct Firebase read
        const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

        const docRef = doc(window.db, 'enhanced_company_rankings', selectedPersona);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          log('‚ùå No ranking found in Firebase', 'error');
          setStatus('Not Found', 'error');
          return;
        }

        const data = docSnap.data();
        log(`‚úÖ Ranking found in Firebase`);
        log(`   Version: ${data.version}`);
        log(`   Updated: ${data.updatedAt}`);
        log(`   Expires: ${data.expiresAt}`);
        log(`   Support companies: ${data.supportCompanies?.length || 0}`);
        log(`   Oppose companies: ${data.opposeCompanies?.length || 0}`);

        // Check if expired
        const expiresAt = new Date(data.expiresAt);
        const isExpired = expiresAt <= new Date();
        log(`   Is Expired: ${isExpired ? '‚ùå YES' : '‚úÖ NO'}`);

        // Display metadata
        const metadata = document.getElementById('metadata');
        const age = Math.round((Date.now() - new Date(data.updatedAt).getTime()) / (1000 * 60 * 60));
        metadata.innerHTML = `
          <div style="font-size: 14px; background: #f9f9f9; padding: 10px; border: 1px solid #ccc;">
            <strong>Source:</strong> ${data.version === '3.0' ? 'üêç Python-generated' : 'üìù TypeScript-generated'}<br>
            <strong>Version:</strong> ${data.version}<br>
            <strong>Updated:</strong> ${new Date(data.updatedAt).toLocaleString()} (${age} hours ago)<br>
            <strong>Expires:</strong> ${expiresAt.toLocaleString()} ${isExpired ? '‚ö†Ô∏è EXPIRED' : '‚úÖ Valid'}<br>
            <strong>Stance:</strong> ${data.stanceType}
          </div>
        `;

        // Display companies
        displayCompanies(data);
        setStatus('Success', 'success');
        log('‚úÖ Test completed successfully', 'success');

      } catch (error) {
        log('‚ùå Error: ' + error.message, 'error');
        setStatus('Error', 'error');
        console.error(error);
      }
    }

    function displayCompanies(data) {
      const container = document.getElementById('companies');
      container.innerHTML = '';

      // Support companies
      const supportDiv = document.createElement('div');
      supportDiv.innerHTML = '<h3 style="margin-top: 0;">üëç Support Companies</h3>';
      (data.supportCompanies || []).forEach((company, i) => {
        const card = document.createElement('div');
        card.className = 'company-card support';
        card.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">
            ${i + 1}. ${company.symbol} - ${company.name}
          </div>
          <div style="font-size: 12px; color: #065f46;">
            Score: ${company.score} | ${company.sector}
          </div>
          <div style="font-size: 11px; color: #047857; margin-top: 5px;">
            ${company.reasoning}
          </div>
        `;
        supportDiv.appendChild(card);
      });

      // Oppose companies
      const opposeDiv = document.createElement('div');
      opposeDiv.innerHTML = '<h3 style="margin-top: 0;">üëé Oppose Companies</h3>';
      (data.opposeCompanies || []).forEach((company, i) => {
        const card = document.createElement('div');
        card.className = 'company-card oppose';
        card.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">
            ${i + 1}. ${company.symbol} - ${company.name}
          </div>
          <div style="font-size: 12px; color: #991b1b;">
            Score: ${company.score} | ${company.sector}
          </div>
          <div style="font-size: 11px; color: #b91c1c; margin-top: 5px;">
            ${company.reasoning}
          </div>
        `;
        opposeDiv.appendChild(card);
      });

      container.appendChild(supportDiv);
      container.appendChild(opposeDiv);
    }

    async function testCheckValidity() {
      try {
        log(`\n${'='.repeat(60)}`);
        log(`üîç Checking cache validity for: ${selectedPersona}`);

        const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
        const docRef = doc(window.db, 'enhanced_company_rankings', selectedPersona);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          log('‚ùå No cache found', 'error');
          return;
        }

        const data = docSnap.data();
        const expiresAt = new Date(data.expiresAt);
        const isValid = expiresAt > new Date();

        log(`   Expires at: ${expiresAt.toLocaleString()}`);
        log(`   Is valid: ${isValid ? '‚úÖ YES' : '‚ùå NO (expired)'}`);
        log(isValid ? '‚úÖ Cache is valid' : '‚ùå Cache is expired', isValid ? 'success' : 'error');

      } catch (error) {
        log('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function testGetAge() {
      try {
        log(`\n${'='.repeat(60)}`);
        log(`‚è∞ Getting ranking age for: ${selectedPersona}`);

        const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
        const docRef = doc(window.db, 'enhanced_company_rankings', selectedPersona);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          log('‚ùå No ranking found', 'error');
          return;
        }

        const data = docSnap.data();
        const updatedAt = new Date(data.updatedAt);
        const ageMs = Date.now() - updatedAt.getTime();
        const ageHours = ageMs / (1000 * 60 * 60);
        const ageMinutes = ageMs / (1000 * 60);

        log(`   Updated at: ${updatedAt.toLocaleString()}`);
        log(`   Age: ${ageHours.toFixed(2)} hours (${ageMinutes.toFixed(0)} minutes)`);
        log(`‚úÖ Age calculated successfully`, 'success');

      } catch (error) {
        log('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Make functions global
    window.testFetchRanking = testFetchRanking;
    window.testCheckValidity = testCheckValidity;
    window.testGetAge = testGetAge;
    window.clearLogs = clearLogs;

    // Initialize on load
    initPersonaSelector();
    log('üöÄ Enhanced Rankings Test Page Ready');
    log('Select a persona and click "Fetch Ranking" to begin');
  </script>
</body>
</html>
