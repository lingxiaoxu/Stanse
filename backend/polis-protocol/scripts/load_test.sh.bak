#!/bin/bash

# Polis Protocol - è´Ÿè½½æµ‹è¯•è„šæœ¬
# æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹çš„æ€§èƒ½å’Œç¨³å®šæ€§

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®
API_URL="${API_URL:-http://localhost:8080}"
CONCURRENT_USERS="${CONCURRENT_USERS:-10}"
TEST_DURATION="${TEST_DURATION:-30s}"
REQUESTS_PER_SECOND="${REQUESTS_PER_SECOND:-100}"

echo -e "${BLUE}================================${NC}"
echo -e "${BLUE}Polis Protocol è´Ÿè½½æµ‹è¯•${NC}"
echo -e "${BLUE}================================${NC}"
echo ""
echo -e "API URL: ${GREEN}$API_URL${NC}"
echo -e "å¹¶å‘ç”¨æˆ·: ${GREEN}$CONCURRENT_USERS${NC}"
echo -e "æµ‹è¯•æ—¶é•¿: ${GREEN}$TEST_DURATION${NC}"
echo -e "ç›®æ ‡RPS: ${GREEN}$REQUESTS_PER_SECOND${NC}"
echo ""

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    echo -e "${YELLOW}æ£€æŸ¥ä¾èµ–å·¥å…·...${NC}"

    if ! command -v ab &> /dev/null; then
        echo -e "${RED}é”™è¯¯: Apache Bench (ab) æœªå®‰è£…${NC}"
        echo "macOS å®‰è£…: ç³»ç»Ÿè‡ªå¸¦"
        echo "Ubuntu å®‰è£…: sudo apt-get install apache2-utils"
        exit 1
    fi

    if ! command -v curl &> /dev/null; then
        echo -e "${RED}é”™è¯¯: curl æœªå®‰è£…${NC}"
        exit 1
    fi

    echo -e "${GREEN}âœ“ ä¾èµ–æ£€æŸ¥å®Œæˆ${NC}"
    echo ""
}

# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
check_server() {
    echo -e "${YELLOW}æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...${NC}"

    if curl -s -f "$API_URL/api/v1/health" > /dev/null; then
        echo -e "${GREEN}âœ“ æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ${NC}"
    else
        echo -e "${RED}é”™è¯¯: æœåŠ¡å™¨æœªè¿è¡Œæˆ–æ— æ³•è®¿é—®${NC}"
        echo "è¯·å…ˆå¯åŠ¨æœåŠ¡å™¨: cargo run --release"
        exit 1
    fi
    echo ""
}

# åˆ›å»ºæµ‹è¯•ç»“æœç›®å½•
RESULTS_DIR="load_test_results_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$RESULTS_DIR"

echo -e "${BLUE}æµ‹è¯•ç»“æœå°†ä¿å­˜åˆ°: $RESULTS_DIR${NC}"
echo ""

# æµ‹è¯•å‡½æ•°
run_test() {
    local test_name="$1"
    local endpoint="$2"
    local method="${3:-GET}"
    local data="${4:-}"
    local requests="${5:-1000}"
    local concurrency="${6:-$CONCURRENT_USERS}"

    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}æµ‹è¯•: $test_name${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    local url="$API_URL$endpoint"
    local output_file="$RESULTS_DIR/${test_name// /_}.txt"

    if [ "$method" = "POST" ]; then
        # POST è¯·æ±‚éœ€è¦ä½¿ç”¨ä¸åŒçš„æ–¹å¼
        echo "$data" > /tmp/post_data.json
        ab -n "$requests" -c "$concurrency" -p /tmp/post_data.json -T "application/json" "$url" > "$output_file" 2>&1
    else
        # GET è¯·æ±‚
        ab -n "$requests" -c "$concurrency" "$url" > "$output_file" 2>&1
    fi

    # æå–å…³é”®æŒ‡æ ‡
    local requests_per_sec=$(grep "Requests per second:" "$output_file" | awk '{print $4}')
    local time_per_request=$(grep "Time per request:" "$output_file" | head -1 | awk '{print $4}')
    local failed_requests=$(grep "Failed requests:" "$output_file" | awk '{print $3}')
    local success_rate=$(echo "scale=2; (($requests - $failed_requests) / $requests) * 100" | bc)

    echo -e "è¯·æ±‚æ€»æ•°: ${GREEN}$requests${NC}"
    echo -e "å¹¶å‘æ•°: ${GREEN}$concurrency${NC}"
    echo -e "è¯·æ±‚/ç§’: ${GREEN}${requests_per_sec:-N/A}${NC}"
    echo -e "å¹³å‡å“åº”æ—¶é—´: ${GREEN}${time_per_request:-N/A} ms${NC}"
    echo -e "å¤±è´¥è¯·æ±‚: ${RED}${failed_requests:-0}${NC}"
    echo -e "æˆåŠŸç‡: ${GREEN}${success_rate}%${NC}"
    echo ""

    # ä¿å­˜åˆ°æ±‡æ€»æ–‡ä»¶
    echo "$test_name,$requests_per_sec,$time_per_request,$failed_requests,$success_rate" >> "$RESULTS_DIR/summary.csv"
}

# åˆå§‹åŒ–æ±‡æ€»æ–‡ä»¶
echo "æµ‹è¯•åç§°,è¯·æ±‚/ç§’,å¹³å‡å“åº”æ—¶é—´(ms),å¤±è´¥è¯·æ±‚æ•°,æˆåŠŸç‡(%)" > "$RESULTS_DIR/summary.csv"

# æ‰§è¡Œä¾èµ–æ£€æŸ¥
check_dependencies
check_server

echo -e "${GREEN}å¼€å§‹è´Ÿè½½æµ‹è¯•...${NC}"
echo ""

# ==================== æµ‹è¯•å¥—ä»¶ ====================

# 1. å¥åº·æ£€æŸ¥ç«¯ç‚¹
run_test "Health Check" "/api/v1/health" "GET" "" 2000 20

# 2. å…¨å±€ç»Ÿè®¡ç«¯ç‚¹
run_test "Global Stats" "/api/v1/stats/global" "GET" "" 1500 15

# 3. æˆ˜çº¿åˆ—è¡¨ç«¯ç‚¹
run_test "Campaigns List" "/api/v1/campaigns" "GET" "" 1000 10

# 4. å•ä¸ªæˆ˜çº¿è¯¦æƒ…
run_test "Campaign Detail" "/api/v1/campaigns/fair-wages-initiative" "GET" "" 1000 10

# 5. ç”¨æˆ·å½±å“åŠ›ç«¯ç‚¹
run_test "User Impact" "/api/v1/user/did:polis:user1/impact" "GET" "" 1000 10

# 6. Prometheus metricsç«¯ç‚¹
run_test "Metrics Endpoint" "/metrics" "GET" "" 500 10

# 7. æäº¤è¡ŒåŠ¨ç«¯ç‚¹ (POST)
ACTION_DATA='{
  "user_did": "did:polis:testuser123",
  "action_type": "BOYCOTT",
  "target_entity": "TestCorp",
  "value_diverted": 10000,
  "zk_proof": "zkproof_load_test_abc123def456789xyz0123456789abcdef",
  "shard_id": "test_shard"
}'
run_test "Submit Action" "/api/v1/actions/submit" "POST" "$ACTION_DATA" 500 10

# ==================== å‹åŠ›æµ‹è¯• ====================

echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}å‹åŠ›æµ‹è¯• - é«˜å¹¶å‘åœºæ™¯${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# é«˜å¹¶å‘æµ‹è¯•
run_test "Stress Test - Health" "/api/v1/health" "GET" "" 5000 50
run_test "Stress Test - Stats" "/api/v1/stats/global" "GET" "" 5000 50

# ==================== ç”ŸæˆæŠ¥å‘Š ====================

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}è´Ÿè½½æµ‹è¯•å®Œæˆ!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# ç”ŸæˆHTMLæŠ¥å‘Š
cat > "$RESULTS_DIR/report.html" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polis Protocol è´Ÿè½½æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th {
            background: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }
        .metric-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .good { color: #27ae60; }
        .warning { color: #f39c12; }
        .bad { color: #e74c3c; }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ Polis Protocol è´Ÿè½½æµ‹è¯•æŠ¥å‘Š</h1>

    <div class="summary">
        <h2>æµ‹è¯•é…ç½®</h2>
        <div class="metric">
            <div class="metric-label">API URL</div>
            <div class="metric-value">PLACEHOLDER_API_URL</div>
        </div>
        <div class="metric">
            <div class="metric-label">æµ‹è¯•æ—¶é—´</div>
            <div class="metric-value">PLACEHOLDER_DATE</div>
        </div>
        <div class="metric">
            <div class="metric-label">å¹¶å‘ç”¨æˆ·</div>
            <div class="metric-value">PLACEHOLDER_CONCURRENT</div>
        </div>
    </div>

    <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
    <table id="resultsTable">
        <thead>
            <tr>
                <th>æµ‹è¯•åç§°</th>
                <th>è¯·æ±‚/ç§’ (RPS)</th>
                <th>å¹³å‡å“åº”æ—¶é—´ (ms)</th>
                <th>å¤±è´¥è¯·æ±‚æ•°</th>
                <th>æˆåŠŸç‡ (%)</th>
            </tr>
        </thead>
        <tbody id="resultsBody">
            <!-- Results will be inserted here -->
        </tbody>
    </table>

    <div class="summary">
        <h2>ğŸ“ˆ æ€§èƒ½è¯„ä¼°</h2>
        <p><strong>ä¼˜ç§€ (Excellent):</strong> RPS > 1000, å“åº”æ—¶é—´ < 10ms, æˆåŠŸç‡ > 99%</p>
        <p><strong>è‰¯å¥½ (Good):</strong> RPS > 500, å“åº”æ—¶é—´ < 50ms, æˆåŠŸç‡ > 95%</p>
        <p><strong>å¯æ¥å— (Acceptable):</strong> RPS > 100, å“åº”æ—¶é—´ < 200ms, æˆåŠŸç‡ > 90%</p>
        <p><strong>éœ€ä¼˜åŒ– (Needs Improvement):</strong> ä½äºä¸Šè¿°æ ‡å‡†</p>
    </div>

    <div class="footer">
        <p>Polis Protocol Load Test Report - Generated by Claude Code Assistant</p>
    </div>

    <script>
        // This will be populated by the shell script
        const csvData = `PLACEHOLDER_CSV_DATA`;

        const lines = csvData.trim().split('\n').slice(1); // Skip header
        const tbody = document.getElementById('resultsBody');

        lines.forEach(line => {
            const [name, rps, time, failed, successRate] = line.split(',');
            const row = tbody.insertRow();

            row.insertCell(0).textContent = name;

            const rpsCell = row.insertCell(1);
            rpsCell.textContent = rps || 'N/A';
            if (parseFloat(rps) > 1000) rpsCell.className = 'good';
            else if (parseFloat(rps) > 500) rpsCell.className = 'warning';
            else rpsCell.className = 'bad';

            const timeCell = row.insertCell(2);
            timeCell.textContent = time || 'N/A';
            if (parseFloat(time) < 10) timeCell.className = 'good';
            else if (parseFloat(time) < 50) timeCell.className = 'warning';
            else timeCell.className = 'bad';

            row.insertCell(3).textContent = failed || '0';

            const successCell = row.insertCell(4);
            successCell.textContent = successRate || 'N/A';
            if (parseFloat(successRate) > 99) successCell.className = 'good';
            else if (parseFloat(successRate) > 95) successCell.className = 'warning';
            else successCell.className = 'bad';
        });
    </script>
</body>
</html>
EOF

# æ›¿æ¢å ä½ç¬¦ - ä½¿ç”¨ perl æ›´å¯é 
CSV_CONTENT=$(cat "$RESULTS_DIR/summary.csv" | sed 's/\\/\\\\/g' | sed 's/`/\\`/g')
TEST_DATE=$(date '+%Y-%m-%d %H:%M:%S')

# ä½¿ç”¨ perl è¿›è¡Œæ›¿æ¢ï¼ˆæ›´å¯é åœ°å¤„ç†å¤šè¡Œå†…å®¹ï¼‰
perl -pi -e "s|PLACEHOLDER_API_URL|$API_URL|g" "$RESULTS_DIR/report.html"
perl -pi -e "s|PLACEHOLDER_DATE|$TEST_DATE|g" "$RESULTS_DIR/report.html"
perl -pi -e "s|PLACEHOLDER_CONCURRENT|$CONCURRENT_USERS|g" "$RESULTS_DIR/report.html"

# CSVå†…å®¹éœ€è¦ç‰¹æ®Šå¤„ç†
python3 -c "
import sys
with open('$RESULTS_DIR/report.html', 'r') as f:
    content = f.read()
with open('$RESULTS_DIR/summary.csv', 'r') as f:
    csv = f.read()
content = content.replace('PLACEHOLDER_CSV_DATA', csv)
with open('$RESULTS_DIR/report.html', 'w') as f:
    f.write(content)
" 2>/dev/null || {
    # å¦‚æœPythonä¸å¯ç”¨,ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬
    sed -i '' "s|PLACEHOLDER_API_URL|$API_URL|g" "$RESULTS_DIR/report.html"
    sed -i '' "s|PLACEHOLDER_DATE|$TEST_DATE|g" "$RESULTS_DIR/report.html"
    sed -i '' "s|PLACEHOLDER_CONCURRENT|$CONCURRENT_USERS|g" "$RESULTS_DIR/report.html"
    sed -i '' "s|PLACEHOLDER_CSV_DATA|See summary.csv|g" "$RESULTS_DIR/report.html"
}

echo -e "è¯¦ç»†ç»“æœ: ${GREEN}$RESULTS_DIR${NC}"
echo -e "HTMLæŠ¥å‘Š: ${GREEN}$RESULTS_DIR/report.html${NC}"
echo -e "CSVæ±‡æ€»: ${GREEN}$RESULTS_DIR/summary.csv${NC}"
echo ""

# æ˜¾ç¤ºæ±‡æ€»
echo -e "${BLUE}æµ‹è¯•æ±‡æ€»:${NC}"
echo ""
column -t -s',' "$RESULTS_DIR/summary.csv"
echo ""

# æ‰“å¼€HTMLæŠ¥å‘Š
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo -e "${YELLOW}æ­£åœ¨æ‰“å¼€HTMLæŠ¥å‘Š...${NC}"
    open "$RESULTS_DIR/report.html"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    if command -v xdg-open &> /dev/null; then
        xdg-open "$RESULTS_DIR/report.html"
    fi
fi

echo -e "${GREEN}âœ“ è´Ÿè½½æµ‹è¯•å®Œæˆ!${NC}"
